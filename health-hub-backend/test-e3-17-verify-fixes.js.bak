/**
 * E3-17 Test: Verify PATCH endpoint audit logging and userRole capture
 * 
 * Tests both fixes:
 * 1. PATCH endpoint status updates are now audited
 * 2. userRole is captured as a snapshot in AuditLog
 */

const axios = require('axios');
const { PrismaClient } = require('@prisma/client');

const prisma = new PrismaClient();
const BASE_URL = 'http://localhost:3000';

// Test credentials
const STAFF_CREDS = { email: 'staff@sobhana.com', password: 'password123' };
const ADMIN_CREDS = { email: 'admin@sobhana.com', password: 'password123' };

let staffToken, adminToken, branchId, patientId;

async function login(credentials) {
  const response = await axios.post(`${BASE_URL}/api/auth/login`, credentials);
  return response.data.token;
}

async function setupTestData() {
  console.log('\n=== SETUP: Creating test data ===');
  
  // Get branch (CNT from seed)
  const branch = await prisma.branch.findFirst({
    where: { code: 'CNT' }
  });
  branchId = branch.id;
  console.log(`âœ“ Using branch: ${branch.name} (${branchId})`);
  
  // Create a test patient
  const patient = await prisma.patient.create({
    data: {
      patientNumber: 'TEST-' + Date.now(),
      name: 'Test Patient for E3-17',
      yearOfBirth: 1990,
      gender: 'M',
    }
  });
  patientId = patient.id;
  console.log(`âœ“ Created patient: ${patient.name} (${patientId})`);
}

async function testPatchAuditLogging() {
  console.log('\n=== TEST 1: PATCH Endpoint Audit Logging ===');
  
  try {
    // Create a diagnostic visit (STAFF role)
    console.log('\n1. Creating diagnostic visit as STAFF...');
    const createResponse = await axios.post(
      `${BASE_URL}/diagnostic`,
      {
        patientId,
        testIds: [], // Empty test list for quick creation
        paymentType: 'CASH',
      },
      {
        headers: { Authorization: `Bearer ${staffToken}` }
      }
    );
    const visitId = createResponse.data.id;
    console.log(`âœ“ Created visit: ${visitId}`);
    
    // Check CREATE audit log
    const createAudit = await prisma.auditLog.findFirst({
      where: {
        entityType: 'VISIT',
        entityId: visitId,
        actionType: 'CREATE'
      }
    });
    
    if (!createAudit) {
      console.error('âœ— CREATE audit log not found');
      return false;
    }
    console.log(`âœ“ CREATE audit logged with role: ${createAudit.userRole || 'NULL'}`);
    
    // Wait a moment for timestamp difference
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // PATCH: Update visit status (STAFF role)
    console.log('\n2. Updating visit status to IN_PROGRESS as STAFF...');
    await axios.patch(
      `${BASE_URL}/diagnostic/${visitId}`,
      { status: 'IN_PROGRESS' },
      {
        headers: { Authorization: `Bearer ${staffToken}` }
      }
    );
    console.log('âœ“ Status updated to IN_PROGRESS');
    
    // Check UPDATE audit log from PATCH
    const patchAudit = await prisma.auditLog.findFirst({
      where: {
        entityType: 'VISIT',
        entityId: visitId,
        actionType: 'UPDATE',
        createdAt: { gt: createAudit.createdAt } // After CREATE
      },
      orderBy: { createdAt: 'desc' }
    });
    
    if (!patchAudit) {
      console.error('âœ— PATCH UPDATE audit log not found');
      return false;
    }
    
    console.log(`âœ“ PATCH UPDATE audit logged`);
    
    // Verify oldValues and newValues
    const oldValues = JSON.parse(patchAudit.oldValues || '{}');
    const newValues = JSON.parse(patchAudit.newValues || '{}');
    
    console.log(`  Old status: ${oldValues.status}`);
    console.log(`  New status: ${newValues.status}`);
    
    if (oldValues.status !== 'WAITING' && oldValues.status !== 'DRAFT') {
      console.error(`âœ— Expected oldValues.status to be WAITING or DRAFT, got: ${oldValues.status}`);
      return false;
    }
    
    if (newValues.status !== 'IN_PROGRESS') {
      console.error(`âœ— Expected newValues.status to be IN_PROGRESS, got: ${newValues.status}`);
      return false;
    }
    
    console.log('âœ“ Old/new values captured correctly');
    
    // Wait a moment for timestamp difference
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // PATCH: Update payment status (ADMIN role)
    console.log('\n3. Updating payment status to PAID as ADMIN...');
    await axios.patch(
      `${BASE_URL}/diagnostic/${visitId}`,
      { paymentStatus: 'PAID' },
      {
        headers: { Authorization: `Bearer ${adminToken}` }
      }
    );
    console.log('âœ“ Payment status updated to PAID');
    
    // Check second UPDATE audit log
    const paymentAudit = await prisma.auditLog.findFirst({
      where: {
        entityType: 'VISIT',
        entityId: visitId,
        actionType: 'UPDATE',
        createdAt: { gt: patchAudit.createdAt } // After first PATCH
      },
      orderBy: { createdAt: 'desc' }
    });
    
    if (!paymentAudit) {
      console.error('âœ— Payment UPDATE audit log not found');
      return false;
    }
    
    console.log(`âœ“ Payment UPDATE audit logged`);
    
    const paymentOldValues = JSON.parse(paymentAudit.oldValues || '{}');
    const paymentNewValues = JSON.parse(paymentAudit.newValues || '{}');
    
    console.log(`  Old paymentStatus: ${paymentOldValues.paymentStatus}`);
    console.log(`  New paymentStatus: ${paymentNewValues.paymentStatus}`);
    
    if (paymentNewValues.paymentStatus !== 'PAID') {
      console.error(`âœ— Expected paymentStatus to be PAID, got: ${paymentNewValues.paymentStatus}`);
      return false;
    }
    
    console.log('âœ“ Payment update captured correctly');
    
    console.log('\nâœ… TEST 1 PASSED: PATCH endpoint audit logging works');
    return true;
    
  } catch (error) {
    console.error('âœ— TEST 1 FAILED:', error.response?.data || error.message);
    return false;
  }
}

async function testUserRoleCapture() {
  console.log('\n=== TEST 2: User Role Snapshot Capture ===');
  
  try {
    // Create a visit as STAFF
    console.log('\n1. Creating visit as STAFF user...');
    const createResponse = await axios.post(
      `${BASE_URL}/diagnostic`,
      {
        patientId,
        testIds: [],
        paymentType: 'INSURANCE',
      },
      {
        headers: { Authorization: `Bearer ${staffToken}` }
      }
    );
    const visitId = createResponse.data.id;
    console.log(`âœ“ Created visit: ${visitId}`);
    
    // Check audit log has userRole
    const staffAudit = await prisma.auditLog.findFirst({
      where: {
        entityType: 'VISIT',
        entityId: visitId,
        actionType: 'CREATE'
      }
    });
    
    if (!staffAudit) {
      console.error('âœ— Audit log not found');
      return false;
    }
    
    console.log(`âœ“ Audit log found`);
    console.log(`  userId: ${staffAudit.userId}`);
    console.log(`  userRole: ${staffAudit.userRole || 'NULL'}`);
    
    if (!staffAudit.userRole) {
      console.error('âœ— userRole is NULL - not captured');
      return false;
    }
    
    if (staffAudit.userRole !== 'staff') {
      console.error(`âœ— Expected role 'staff', got: ${staffAudit.userRole}`);
      return false;
    }
    
    console.log('âœ“ STAFF role captured correctly');
    
    // Wait a moment
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // Update visit as ADMIN
    console.log('\n2. Updating visit as ADMIN user...');
    await axios.patch(
      `${BASE_URL}/diagnostic/${visitId}`,
      { status: 'COMPLETED' },
      {
        headers: { Authorization: `Bearer ${adminToken}` }
      }
    );
    console.log('âœ“ Status updated to COMPLETED');
    
    // Check admin's audit log
    const adminAudit = await prisma.auditLog.findFirst({
      where: {
        entityType: 'VISIT',
        entityId: visitId,
        actionType: 'UPDATE',
        createdAt: { gt: staffAudit.createdAt }
      },
      orderBy: { createdAt: 'desc' }
    });
    
    if (!adminAudit) {
      console.error('âœ— Admin audit log not found');
      return false;
    }
    
    console.log(`âœ“ Admin audit log found`);
    console.log(`  userId: ${adminAudit.userId}`);
    console.log(`  userRole: ${adminAudit.userRole || 'NULL'}`);
    
    if (!adminAudit.userRole) {
      console.error('âœ— userRole is NULL - not captured');
      return false;
    }
    
    if (adminAudit.userRole !== 'admin') {
      console.error(`âœ— Expected role 'admin', got: ${adminAudit.userRole}`);
      return false;
    }
    
    console.log('âœ“ ADMIN role captured correctly');
    
    // Verify immutability - check that we have both snapshots
    console.log('\n3. Verifying role immutability...');
    const allAudits = await prisma.auditLog.findMany({
      where: {
        entityType: 'VISIT',
        entityId: visitId
      },
      orderBy: { createdAt: 'asc' }
    });
    
    console.log(`âœ“ Found ${allAudits.length} audit logs for this visit:`);
    allAudits.forEach((audit, idx) => {
      console.log(`  ${idx + 1}. ${audit.actionType} by ${audit.userRole || 'NULL'} at ${audit.createdAt.toISOString()}`);
    });
    
    // Verify we have different roles in history
    const roles = allAudits.map(a => a.userRole).filter(Boolean);
    const uniqueRoles = [...new Set(roles)];
    
    if (uniqueRoles.length < 2) {
      console.error('âœ— Expected at least 2 different roles in audit history');
      return false;
    }
    
    console.log(`âœ“ Multiple roles captured: ${uniqueRoles.join(', ')}`);
    console.log('âœ“ Role snapshots are immutable - each action preserves the role at that time');
    
    console.log('\nâœ… TEST 2 PASSED: User role snapshot capture works');
    return true;
    
  } catch (error) {
    console.error('âœ— TEST 2 FAILED:', error.response?.data || error.message);
    return false;
  }
}

async function cleanup() {
  console.log('\n=== Cleanup ===');
  await prisma.$disconnect();
  console.log('âœ“ Database connection closed');
}

async function runTests() {
  console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘  E3-17 Verification: PATCH Audit + Role Snapshot Tests   â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  
  try {
    // Login
    console.log('\n=== Authentication ===');
    staffToken = await login(STAFF_CREDS);
    console.log('âœ“ Logged in as STAFF');
    adminToken = await login(ADMIN_CREDS);
    console.log('âœ“ Logged in as ADMIN');
    
    // Setup
    await setupTestData();
    
    // Run tests
    const test1Pass = await testPatchAuditLogging();
    const test2Pass = await testUserRoleCapture();
    
    // Summary
    console.log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log('â•‘                      TEST SUMMARY                         â•‘');
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log(`\nTest 1 (PATCH Audit Logging):     ${test1Pass ? 'âœ… PASSED' : 'âŒ FAILED'}`);
    console.log(`Test 2 (Role Snapshot Capture):   ${test2Pass ? 'âœ… PASSED' : 'âŒ FAILED'}`);
    
    if (test1Pass && test2Pass) {
      console.log('\nðŸŽ‰ ALL TESTS PASSED! Both E3-17 fixes verified.');
      console.log('\nâœ“ Fix 1: PATCH endpoint now logs status/payment updates');
      console.log('âœ“ Fix 2: userRole is captured as immutable snapshot in AuditLog');
    } else {
      console.log('\nâŒ SOME TESTS FAILED - see details above');
      process.exit(1);
    }
    
  } catch (error) {
    console.error('\nðŸ’¥ Test execution error:', error.message);
    process.exit(1);
  } finally {
    await cleanup();
  }
}

// Run tests
runTests();
